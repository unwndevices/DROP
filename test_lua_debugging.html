<!DOCTYPE html>
<html>
<head>
    <title>enjin2 Lua Debugging Test</title>
</head>
<body>
    <h1>enjin2 Lua Debugging Test</h1>
    <div id="output"></div>
    
    <script type="module">
        const output = document.getElementById('output');
        
        function log(message) {
            output.innerHTML += message + '<br>';
            console.log(message);
        }
        
        async function testLuaDebugging() {
            try {
                log('Loading enjin2 module...');
                
                // Import the enjin2 module
                const Enjin2Module = await import('/enjin2.js');
                
                log('Creating module instance...');
                const module = await Enjin2Module.default();
                
                log('Module loaded. Available functions: ' + Object.keys(module).slice(0, 10).join(', '));
                
                // Test if basic functions are available
                if (module.testFunction) {
                    log('✅ testFunction found: ' + module.testFunction());
                } else {
                    log('❌ testFunction not found');
                }
                
                if (module.LuaScriptSystem) {
                    log('✅ LuaScriptSystem found');
                    
                    // Create script system
                    const scriptSystem = new module.LuaScriptSystem();
                    const initialized = scriptSystem.initialize();
                    log('Script system initialized: ' + initialized);
                    
                    if (initialized) {
                        // Test basic Lua execution
                        log('Testing basic Lua execution...');
                        const basicTest = scriptSystem.executeScript(`
                            print("Hello from Lua!")
                            print("Math test: 5 + 3 = " .. (5 + 3))
                            return true
                        `);
                        log('Basic test result: ' + JSON.stringify(basicTest));
                        
                        // Test function availability check
                        if (module.debugLuaBindings) {
                            log('Testing Lua bindings debug...');
                            const debugResult = module.debugLuaBindings(scriptSystem);
                            log('Debug bindings result: ' + debugResult);
                        } else {
                            log('❌ debugLuaBindings not found');
                        }
                        
                        // Test canvas creation
                        if (module.Canvas4_128x128) {
                            log('✅ Canvas4_128x128 found');
                            const canvas = new module.Canvas4_128x128();
                            
                            if (module.createLuaCanvas128) {
                                log('✅ createLuaCanvas128 found');
                                const luaCanvas = module.createLuaCanvas128();
                                scriptSystem.setCanvas(luaCanvas);
                                
                                // Test drawing functions
                                log('Testing drawing functions...');
                                const drawTest = scriptSystem.executeScript(`
                                    print("Testing drawing functions...")
                                    if clear then
                                        print("clear function found")
                                        clear(0)
                                        print("Canvas cleared")
                                    else
                                        print("clear function NOT found")
                                    end
                                    
                                    if point then
                                        print("point function found")
                                        point(10, 10, 15)
                                        print("Drew point")
                                    else
                                        print("point function NOT found")
                                    end
                                    
                                    return true
                                `);
                                log('Draw test result: ' + JSON.stringify(drawTest));
                                
                                // Check canvas data
                                if (module.getCanvasData128) {
                                    const canvasData = module.getCanvasData128(canvas);
                                    log('Canvas data length: ' + canvasData.length);
                                    const nonZeroPixels = Array.from(canvasData).filter(x => x !== 0).length;
                                    log('Non-zero pixels: ' + nonZeroPixels);
                                    
                                    if (nonZeroPixels > 0) {
                                        log('✅ Canvas has non-zero pixels! Drawing is working!');
                                    } else {
                                        log('❌ Canvas is still all zeros - drawing not working');
                                    }
                                }
                            } else {
                                log('❌ createLuaCanvas128 not found');
                            }
                        } else {
                            log('❌ Canvas4_128x128 not found');
                        }
                    }
                } else {
                    log('❌ LuaScriptSystem not found');
                }
                
            } catch (error) {
                log('❌ Test failed: ' + error.message);
                console.error(error);
            }
        }
        
        testLuaDebugging();
    </script>
</body>
</html>