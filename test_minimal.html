<!DOCTYPE html>
<html>
<head>
    <title>Minimal enjin2 Test</title>
</head>
<body>
    <h1>Minimal enjin2 Test</h1>
    <div id="output"></div>
    
    <script type="module">
        const output = document.getElementById('output');
        
        function log(message) {
            output.innerHTML += message + '<br>';
            console.log(message);
        }
        
        async function test() {
            try {
                // Load enjin2 module
                const script = document.createElement('script');
                script.src = '/enjin2.js';
                script.type = 'module';
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                
                // Wait for module
                while (!window.Enjin2Module) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                log('‚úÖ Module loaded');
                
                const enjin2Module = await window.Enjin2Module();
                log('‚úÖ Module instantiated');
                
                const scriptSystem = new enjin2Module.LuaScriptSystem();
                const initialized = scriptSystem.initialize();
                log('‚úÖ Lua initialized: ' + initialized);
                
                const canvas = new enjin2Module.Canvas4_128x128();
                const luaCanvas = enjin2Module.createLuaCanvas128();
                scriptSystem.setCanvas(luaCanvas);
                log('‚úÖ Canvas set');
                
                const setupSuccess = enjin2Module.setupGlobalLuaFunctions(scriptSystem);
                log('‚úÖ Global functions setup: ' + setupSuccess);
                
                // Test the exact same script as PixelArtGenerator
                const testScript = `
                    -- Frame variables
                    f = 0
                    f_amt = 1
                    
                    -- Canvas dimensions
                    canvas_width = 128
                    canvas_height = 128
                    
                    -- User script (the DEFAULT_SCRIPT from PixelArtGenerator)
                    clear(0)  -- Clear to black (enjin2 native API)

                    -- Canvas dimensions and center (enjin2 native API)
                    local w = getWidth()
                    local h = getHeight()
                    local cx = w / 2
                    local cy = h / 2
                `;
                
                log('üß™ Testing script...');
                const result = scriptSystem.executeScript(testScript);
                log('Result: success=' + result.success);
                if (!result.success) {
                    log('‚ùå Error: ' + result.error);
                } else {
                    log('‚úÖ Script executed successfully!');
                }
                
            } catch (error) {
                log('‚ùå Test failed: ' + error.message);
                console.error(error);
            }
        }
        
        test();
    </script>
</body>
</html>